{% load static %}

<div id="foundRoutes">
    <span id="loader"></span>
</div>

<script>
    let current_solution;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('click', function (event) {
            if (event.target.classList.contains('solution')) {
                current_solution = event.target.id;
                handle_route_click(event.target.id)
            }
        });
    });

    window.addEventListener("vehiclePositionsUpdated", (e) => {
        const vehicles_data = e.detail;
        show_vehicles(current_solution)
    });

    window.addEventListener("tripUpdatesUpdated", (e) => {
        const trip_updates_data = e.detail;
    });

    const handle_route_click = (solution_id) => {
        let coords, details;

        const departureCoordinatesSessionStorage = sessionStorage.getItem('departureCoordinates');

        // Check if data exists
        if (departureCoordinatesSessionStorage) {
            const departureCoordinates = JSON.parse(departureCoordinatesSessionStorage);

            coords = departureCoordinates[solution_id];
            draw_route(coords);
        }

        const departureDetailsSessionStorage = sessionStorage.getItem('departuresDetails');

        if (departureDetailsSessionStorage) {
            const departureDetails = JSON.parse(departureDetailsSessionStorage);

            details = departureDetails[solution_id];
            show_departure_details(details);
        }


        show_vehicles(solution_id)


    }

    const show_departure_details = (details) => {

        const departureDetailsContainer = document.getElementById('departureDetailsContent');
        departureDetailsContainer.innerHTML = '';

        // Append all departure details
        Object.values(details).forEach(departureDiv => {
            departureDetailsContainer.innerHTML += departureDiv;
        });

        document.getElementById('departureDetails').style.display = "flex";
        document.getElementById("arrow-icon-hours").addEventListener("click", function () {
            document.getElementById('departureDetails').style.display = "none";
        });

    }

    const show_vehicles = (solution_id) => {
        const departureGTFSSessionStorage = sessionStorage.getItem('departuresGTFS');

        if (departureGTFSSessionStorage) {
            const departureGTFS = JSON.parse(departureGTFSSessionStorage);

            let trip_ids = departureGTFS[solution_id];
            removeVehiclesRoutingControl();

            for (let trip_id in trip_ids) {
                const filteredVehicles = GTFS_DATA.vehicles_data.filter(
                    vehicle => vehicle.trip_id === trip_ids[trip_id]
                );

                filteredVehicles.forEach(vehicle => {
                    const marker = L.marker([vehicle.latitude, vehicle.longitude], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `<div class="marker-circle">${vehicle.route_id || 'N/A'}</div>`,
                            iconSize: [25, 25], // Icon size
                            iconAnchor: [12.5, 12.5], // Center the icon
                        }),
                    }).bindPopup(
                        `<b>ID pojazdu:</b> ${vehicle.vehicle_id}<br>
                     <b>ID odjazdu:</b> ${vehicle.route_id}<br>
                     <b>Data:</b> ${vehicle.timestamp}`
                    );

                    // Add the marker to the map
                    marker.addTo(map);

                    // Track the marker for removal later
                    vehiclesControls.push(marker);
                });
            }
        }
    };

</script>
